commands:

  check: |
    set -e
    set +x
    echo "machine ${SMUGGLER_host} login ${SMUGGLER_user} password ${SMUGGLER_pass}" > ~/.netrc
    set -x

    curl --max-time 10 --retry 3 -n "https://${SMUGGLER_host}${SMUGGLER_job}/api/json" > "${SMUGGLER_OUTPUT_DIR}/raw"
    jq '.builds | .[].number' < "${SMUGGLER_OUTPUT_DIR}/raw" | tac > "${SMUGGLER_OUTPUT_DIR}/versions"

  in: |
    set -e
    set +x
    echo "machine ${SMUGGLER_host} login ${SMUGGLER_user} password ${SMUGGLER_pass}" > ~/.netrc
    set -x

    while true; do
      curl --max-time 10 --retry 3 -n "https://${SMUGGLER_host}${SMUGGLER_job}/${SMUGGLER_VERSION_ID}/api/json" > "${SMUGGLER_DESTINATION_DIR}/raw"

      jq -r '.result' < "${SMUGGLER_DESTINATION_DIR}/raw" > ${SMUGGLER_DESTINATION_DIR}/result
      jq -r '.url'    < "${SMUGGLER_DESTINATION_DIR}/raw" > ${SMUGGLER_DESTINATION_DIR}/url

      time_ms=$(jq -r '.timestamp' <  "${SMUGGLER_DESTINATION_DIR}/raw")
      echo ${time_ms}     > ${SMUGGLER_DESTINATION_DIR}/start_time_ms
      echo ${time_ms%???} > ${SMUGGLER_DESTINATION_DIR}/start_time_s

      printf 'date='                                                   > ${SMUGGLER_OUTPUT_DIR}/metadata
      date -d @"$(cat ${SMUGGLER_DESTINATION_DIR}/start_time_s)"       >> ${SMUGGLER_OUTPUT_DIR}/metadata

      printf 'build_id=%s\n' ${SMUGGLER_VERSION_ID}                    >> ${SMUGGLER_OUTPUT_DIR}/metadata
      printf 'url=%s\n'      $(cat ${SMUGGLER_DESTINATION_DIR}/url)    >> ${SMUGGLER_OUTPUT_DIR}/metadata
      printf 'result=%s\n'   $(cat ${SMUGGLER_DESTINATION_DIR}/result) >> ${SMUGGLER_OUTPUT_DIR}/metadata

      if [[ -z "${SMUGGLER_requireResult:-}" ]]; then
        echo "OK!" >&2
        break
      elif [[ "$(cat ${SMUGGLER_DESTINATION_DIR}/result)" == "null" ]]; then
        echo "Still thinking..." >&2
        sleep 5
      elif [[ "$(cat ${SMUGGLER_DESTINATION_DIR}/result)" == "${SMUGGLER_requireResult}" ]]; then
        echo "OK!" >&2
        break
      else
        echo "Wrong result :|" >&2
        exit 1
      fi
    done


  out: |
    set -e
    set +x
    echo "machine ${SMUGGLER_host} login ${SMUGGLER_user} password ${SMUGGLER_pass}" > ~/.netrc
    set -x

    if [[ -n "${SMUGGLER_buildParams:-}" ]]; then
      curl -X POST -D headers --max-time 10 --retry 3 -n "https://${SMUGGLER_host}${SMUGGLER_job}/buildWithParameters" -d "${SMUGGLER_buildParams}"
    else
      curl -X POST -D headers --max-time 10 --retry 3 -n "https://${SMUGGLER_host}${SMUGGLER_job}/build"
    fi

    queue=$(grep '^Location: ' headers | cut -d ' ' -f 2- | sed -e 's/[[:space:]]*$//')

    n=0
    until [[ $n -ge 20 ]]; do
      jobid=$(curl --max-time 10 --retry 3 -n "${queue}/api/json" | jq '.executable.number')
      if [[ "${jobid}" == "null" ]]; then
        echo "Build is not scheduled yet" >&2
        sleep 3
      else
        echo "${jobid}" > "${SMUGGLER_OUTPUT_DIR}/versions"
        break
      fi
    done
